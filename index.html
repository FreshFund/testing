<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SpecSort â€” Construction Document Organizer</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;900&family=IBM+Plex+Mono:wght@400;500&family=Barlow:wght@400;500;600&display=swap');

  :root {
    --bg: #0e0f0e;
    --surface: #181a17;
    --surface2: #1f2320;
    --border: #2c302b;
    --accent: #c8f000;
    --accent2: #ff6b2b;
    --warn: #ffb800;
    --text: #d4d8cf;
    --text-dim: #7a8075;
    --text-bright: #eef2e8;
    --red: #ff4444;
    --blue: #4db8ff;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Barlow', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* HEADER */
  header {
    background: var(--surface);
    border-bottom: 2px solid var(--accent);
    padding: 0 2rem;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .logo {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 900;
    font-size: 1.8rem;
    letter-spacing: 0.04em;
    color: var(--accent);
    text-transform: uppercase;
  }
  .logo span { color: var(--text-dim); font-weight: 400; }

  .header-tag {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.7rem;
    color: var(--text-dim);
    background: var(--surface2);
    border: 1px solid var(--border);
    padding: 4px 10px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  /* MAIN LAYOUT */
  main {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
  }

  /* UPLOAD ZONE */
  .upload-section {
    margin-bottom: 2rem;
  }

  .section-label {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: 0.75rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .section-label::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .drop-zone {
    border: 2px dashed var(--border);
    background: var(--surface);
    padding: 3rem 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }
  .drop-zone::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, transparent 40%, rgba(200,240,0,0.03) 100%);
    pointer-events: none;
  }
  .drop-zone:hover, .drop-zone.dragover {
    border-color: var(--accent);
    background: rgba(200,240,0,0.04);
  }

  .drop-icon {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    opacity: 0.4;
  }

  .drop-title {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: 1.4rem;
    text-transform: uppercase;
    color: var(--text-bright);
    margin-bottom: 0.5rem;
    letter-spacing: 0.05em;
  }

  .drop-sub {
    font-size: 0.85rem;
    color: var(--text-dim);
    font-family: 'IBM Plex Mono', monospace;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.6rem 1.4rem;
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: 0.95rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    border: none;
    transition: all 0.15s;
  }
  .btn-primary {
    background: var(--accent);
    color: #0e0f0e;
  }
  .btn-primary:hover { background: #d8ff10; transform: translateY(-1px); }
  .btn-ghost {
    background: transparent;
    color: var(--text);
    border: 1px solid var(--border);
  }
  .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  /* FILE QUEUE */
  .file-queue {
    margin-top: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .file-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 0.75rem 1rem;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.8rem;
  }

  .file-item .file-name { flex: 1; color: var(--text-bright); }
  .file-item .file-size { color: var(--text-dim); }
  .file-status {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 2px 8px;
  }
  .status-pending { background: var(--surface2); color: var(--text-dim); }
  .status-processing { background: rgba(255,184,0,0.15); color: var(--warn); }
  .status-done { background: rgba(200,240,0,0.12); color: var(--accent); }
  .status-error { background: rgba(255,68,68,0.12); color: var(--red); }

  .remove-btn {
    background: none;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 1rem;
    line-height: 1;
    padding: 2px 6px;
    transition: color 0.15s;
  }
  .remove-btn:hover { color: var(--red); }

  /* ANALYZE BAR */
  .analyze-bar {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border);
  }

  .progress-wrap {
    flex: 1;
    height: 4px;
    background: var(--surface2);
    overflow: hidden;
    display: none;
  }
  .progress-bar {
    height: 100%;
    background: var(--accent);
    width: 0%;
    transition: width 0.3s;
  }
  .progress-label {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.75rem;
    color: var(--warn);
    display: none;
  }

  /* RESULTS */
  #results { display: none; }

  .results-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .results-title {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 900;
    font-size: 2rem;
    text-transform: uppercase;
    color: var(--text-bright);
    letter-spacing: 0.05em;
  }
  .results-title span { color: var(--accent); }

  /* STATS ROW */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1px;
    background: var(--border);
    border: 1px solid var(--border);
    margin-bottom: 2rem;
  }

  .stat-card {
    background: var(--surface);
    padding: 1.25rem 1rem;
    text-align: center;
  }

  .stat-value {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 900;
    font-size: 2.2rem;
    color: var(--accent);
    line-height: 1;
  }

  .stat-label {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.65rem;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-top: 0.4rem;
  }

  /* TABS */
  .tabs {
    display: flex;
    gap: 0;
    border-bottom: 2px solid var(--border);
    margin-bottom: 2rem;
  }

  .tab {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: 0.9rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 0.75rem 1.5rem;
    cursor: pointer;
    color: var(--text-dim);
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    transition: all 0.15s;
    background: none;
    border-top: none;
    border-left: none;
    border-right: none;
  }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

  /* DOCUMENT GRID */
  .doc-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: 1px;
    background: var(--border);
  }

  .doc-card {
    background: var(--surface);
    padding: 1.25rem;
    transition: background 0.15s;
    cursor: pointer;
    position: relative;
    overflow: hidden;
  }
  .doc-card::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 3px;
    background: var(--priority-color, var(--border));
  }
  .doc-card:hover { background: var(--surface2); }

  .doc-card-top {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
  }

  .doc-type-badge {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.65rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    padding: 2px 8px;
    background: var(--surface2);
    color: var(--text-dim);
    border: 1px solid var(--border);
    white-space: nowrap;
  }

  .priority-badge {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: 0.7rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    padding: 2px 8px;
    white-space: nowrap;
  }
  .priority-critical { background: rgba(255,68,68,0.15); color: var(--red); }
  .priority-high { background: rgba(255,107,43,0.15); color: var(--accent2); }
  .priority-medium { background: rgba(255,184,0,0.15); color: var(--warn); }
  .priority-low { background: rgba(200,240,0,0.1); color: var(--accent); }

  .doc-title {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: 1.1rem;
    color: var(--text-bright);
    letter-spacing: 0.02em;
    margin-bottom: 0.5rem;
    line-height: 1.2;
  }

  .doc-section {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.7rem;
    color: var(--blue);
    margin-bottom: 0.75rem;
  }

  .doc-summary {
    font-size: 0.85rem;
    color: var(--text-dim);
    line-height: 1.5;
    margin-bottom: 0.75rem;
  }

  .doc-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
  }

  .tag {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.62rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    padding: 2px 7px;
    background: var(--surface2);
    color: var(--text-dim);
    border: 1px solid var(--border);
  }

  .doc-footer {
    margin-top: 1rem;
    padding-top: 0.75rem;
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .doc-filename {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.65rem;
    color: var(--text-dim);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 60%;
  }

  .doc-trade {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 600;
    font-size: 0.75rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-dim);
  }

  /* GROUP VIEW */
  .group-view { display: none; }

  .group-block {
    margin-bottom: 2rem;
    border: 1px solid var(--border);
  }

  .group-header {
    background: var(--surface2);
    padding: 0.75rem 1rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border);
  }

  .group-name {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-bright);
  }

  .group-count {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.75rem;
    color: var(--text-dim);
  }

  .group-body {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: 1px;
    background: var(--border);
  }

  /* DOWNLOAD PANEL */
  .download-panel {
    margin-top: 2rem;
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .download-info {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.8rem;
    color: var(--text-dim);
  }
  .download-info strong { color: var(--text-bright); display: block; margin-bottom: 0.25rem; font-family: 'Barlow Condensed', sans-serif; font-size: 1rem; letter-spacing: 0.05em; text-transform: uppercase; }

  /* MODAL */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    z-index: 200;
    align-items: center;
    justify-content: center;
    padding: 2rem;
  }
  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-top: 3px solid var(--accent);
    max-width: 700px;
    width: 100%;
    max-height: 85vh;
    overflow-y: auto;
    padding: 2rem;
  }

  .modal-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
  }

  .modal-title {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 900;
    font-size: 1.6rem;
    color: var(--text-bright);
    text-transform: uppercase;
    letter-spacing: 0.04em;
    line-height: 1.2;
    max-width: 80%;
  }

  .close-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--text-dim);
    cursor: pointer;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    flex-shrink: 0;
  }
  .close-btn:hover { border-color: var(--accent); color: var(--accent); }

  .modal-field {
    margin-bottom: 1.25rem;
  }

  .modal-field-label {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--text-dim);
    margin-bottom: 0.4rem;
  }

  .modal-field-value {
    font-size: 0.9rem;
    color: var(--text);
    line-height: 1.6;
  }

  .modal-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1.25rem;
  }

  /* EMPTY STATE */
  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-dim);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.85rem;
  }

  /* SCROLLBAR */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); }
  ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

  /* API KEY BANNER */
  .api-banner {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 0.75rem 2rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
  }
  .api-label {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-dim);
    white-space: nowrap;
  }
  .api-input-wrap {
    flex: 1;
    min-width: 260px;
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }
  .api-input {
    flex: 1;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text-bright);
    padding: 0.45rem 0.75rem;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.78rem;
    outline: none;
    transition: border-color 0.15s;
  }
  .api-input:focus { border-color: var(--accent); }
  .api-input::placeholder { color: var(--text-dim); }
  .api-status {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.7rem;
    white-space: nowrap;
  }
  .api-status.set { color: var(--accent); }
  .api-status.unset { color: var(--text-dim); }
  .api-hint {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.65rem;
    color: var(--text-dim);
    flex-basis: 100%;
  }
  .api-hint a { color: var(--blue); text-decoration: none; }
  .api-hint a:hover { text-decoration: underline; }

  /* ANIMATIONS */
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .doc-card { animation: slideIn 0.3s ease forwards; }

  .pulse {
    animation: pulse 1.5s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">SpecSort <span>/ Construction Doc Organizer</span></div>
  <div class="header-tag">AI-Powered Â· CSI Format</div>
</header>

<div class="api-banner">
  <span class="api-label">ðŸ”‘ Anthropic API Key</span>
  <div class="api-input-wrap">
    <input type="password" class="api-input" id="apiKeyInput" placeholder="sk-ant-api03-..." oninput="handleApiKeyInput(this.value)" autocomplete="off" />
    <span class="api-status unset" id="apiStatus">â¬¤ Not set</span>
  </div>
  <span class="api-hint">Your key is never stored or sent anywhere except directly to <a href="https://console.anthropic.com" target="_blank">api.anthropic.com</a>. Get a key at <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a>.</span>
</div>

<main>
  <!-- UPLOAD -->
  <div class="upload-section">
    <div class="section-label">01 â€” Upload Documents</div>

    <div class="drop-zone" id="dropZone">
      <div class="drop-icon">ðŸ“„</div>
      <div class="drop-title">Drop Construction PDFs Here</div>
      <div class="drop-sub">Specs, Submittals, Shop Drawings, Product Data â€” PDF files</div>
      <br>
      <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
        âŠ• Select Files
      </button>
      <input type="file" id="fileInput" accept=".pdf" multiple style="display:none" />
    </div>

    <div class="file-queue" id="fileQueue"></div>

    <div class="analyze-bar">
      <button class="btn btn-primary" id="analyzeBtn" disabled onclick="analyzeAll()">
        â–¶ Analyze Documents
      </button>
      <button class="btn btn-ghost" id="clearBtn" onclick="clearAll()" style="display:none">
        âœ• Clear All
      </button>
      <div class="progress-wrap" id="progressWrap">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <div class="progress-label pulse" id="progressLabel"></div>
    </div>
  </div>

  <!-- RESULTS -->
  <div id="results">
    <div class="results-header">
      <div class="results-title">Analysis <span>Results</span></div>
      <div style="display:flex;gap:0.5rem;">
        <button class="btn btn-ghost" onclick="downloadJSON()">â¬‡ Export JSON</button>
        <button class="btn btn-ghost" onclick="downloadCSV()">â¬‡ Export CSV</button>
      </div>
    </div>

    <div class="stats-row" id="statsRow"></div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('grid', this)">All Documents</button>
      <button class="tab" onclick="switchTab('byTopic', this)">By Topic / CSI Division</button>
      <button class="tab" onclick="switchTab('byPriority', this)">By Priority</button>
      <button class="tab" onclick="switchTab('byType', this)">By Document Type</button>
    </div>

    <div id="gridView" class="doc-grid"></div>
    <div id="byTopicView" class="group-view"></div>
    <div id="byPriorityView" class="group-view"></div>
    <div id="byTypeView" class="group-view"></div>

    <div class="download-panel">
      <div class="download-info">
        <strong>Export Organized Report</strong>
        Full structured summary with all assessments, tags, and groupings
      </div>
      <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
        <button class="btn btn-primary" onclick="downloadHTML()">â¬‡ Download HTML Report</button>
        <button class="btn btn-ghost" onclick="downloadJSON()">â¬‡ Download JSON</button>
      </div>
    </div>
  </div>
</main>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
  <div class="modal" id="modalContent">
    <div class="modal-top">
      <div class="modal-title" id="modalTitle"></div>
      <button class="close-btn" onclick="closeModalBtn()">âœ•</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script>
  const PRIORITY_COLORS = {
    'Critical': '#ff4444',
    'High': '#ff6b2b',
    'Medium': '#ffb800',
    'Low': '#c8f000'
  };

  let apiKey = '';

  function handleApiKeyInput(val) {
    apiKey = val.trim();
    const status = document.getElementById('apiStatus');
    if (apiKey.startsWith('sk-ant-') && apiKey.length > 20) {
      status.textContent = 'â¬¤ Key set';
      status.className = 'api-status set';
    } else {
      status.textContent = 'â¬¤ Not set';
      status.className = 'api-status unset';
    }
  }

  let files = [];
  let analyzedDocs = [];

  // --- FILE HANDLING ---
  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('fileInput');

  dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
  dropZone.addEventListener('drop', e => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    addFiles([...e.dataTransfer.files].filter(f => f.type === 'application/pdf'));
  });
  fileInput.addEventListener('change', e => addFiles([...e.target.files]));

  function addFiles(newFiles) {
    newFiles.forEach(f => {
      if (!files.find(x => x.name === f.name)) {
        files.push(f);
      }
    });
    renderQueue();
    document.getElementById('analyzeBtn').disabled = files.length === 0;
    document.getElementById('clearBtn').style.display = files.length ? 'inline-flex' : 'none';
    fileInput.value = '';
  }

  function renderQueue() {
    const q = document.getElementById('fileQueue');
    q.innerHTML = '';
    files.forEach((f, i) => {
      const div = document.createElement('div');
      div.className = 'file-item';
      div.id = `file-${i}`;
      div.innerHTML = `
        <span style="color:var(--accent);font-size:1rem;">ðŸ“„</span>
        <span class="file-name">${f.name}</span>
        <span class="file-size">${(f.size/1024).toFixed(0)} KB</span>
        <span class="file-status status-pending" id="status-${i}">Pending</span>
        <button class="remove-btn" onclick="removeFile(${i})">âœ•</button>
      `;
      q.appendChild(div);
    });
  }

  function removeFile(i) {
    files.splice(i, 1);
    renderQueue();
    document.getElementById('analyzeBtn').disabled = files.length === 0;
    document.getElementById('clearBtn').style.display = files.length ? 'inline-flex' : 'none';
  }

  function clearAll() {
    files = [];
    analyzedDocs = [];
    renderQueue();
    document.getElementById('analyzeBtn').disabled = true;
    document.getElementById('clearBtn').style.display = 'none';
    document.getElementById('results').style.display = 'none';
    document.getElementById('progressWrap').style.display = 'none';
    document.getElementById('progressLabel').style.display = 'none';
  }

  // --- PDF TO BASE64 ---
  function fileToBase64(file) {
    return new Promise((res, rej) => {
      const r = new FileReader();
      r.onload = () => res(r.result.split(',')[1]);
      r.onerror = () => rej(new Error('Read failed'));
      r.readAsDataURL(file);
    });
  }

  // --- ANALYZE ---
  async function analyzeAll() {
    if (!apiKey || !apiKey.startsWith('sk-ant-')) {
      document.getElementById('apiKeyInput').focus();
      document.getElementById('apiKeyInput').style.borderColor = 'var(--red)';
      setTimeout(() => document.getElementById('apiKeyInput').style.borderColor = '', 2000);
      alert('Please enter your Anthropic API key first.');
      return;
    }
    const btn = document.getElementById('analyzeBtn');
    btn.disabled = true;
    document.getElementById('clearBtn').style.display = 'none';
    document.getElementById('results').style.display = 'none';
    analyzedDocs = [];

    const progressWrap = document.getElementById('progressWrap');
    const progressBar = document.getElementById('progressBar');
    const progressLabel = document.getElementById('progressLabel');
    progressWrap.style.display = 'block';
    progressLabel.style.display = 'block';

    for (let i = 0; i < files.length; i++) {
      const f = files[i];
      setStatus(i, 'processing', 'Analyzing...');
      progressLabel.textContent = `Analyzing ${i+1} of ${files.length}: ${f.name}`;
      progressBar.style.width = `${((i) / files.length) * 100}%`;

      try {
        const base64 = await fileToBase64(f);
        const result = await analyzeDocument(base64, f.name);
        result.filename = f.name;
        analyzedDocs.push(result);
        setStatus(i, 'done', 'Done');
      } catch (err) {
        console.error(err);
        setStatus(i, 'error', 'Error');
        analyzedDocs.push({
          filename: f.name,
          title: f.name,
          docType: 'Unknown',
          csiDivision: 'Unknown',
          csiSection: '',
          trade: 'Unknown',
          priority: 'Medium',
          summary: 'Could not analyze this document.',
          keyItems: [],
          tags: [],
          notes: ''
        });
      }

      progressBar.style.width = `${((i+1) / files.length) * 100}%`;
    }

    progressLabel.textContent = 'Analysis complete!';
    progressLabel.classList.remove('pulse');
    setTimeout(() => {
      progressWrap.style.display = 'none';
      progressLabel.style.display = 'none';
    }, 2000);

    btn.disabled = false;
    document.getElementById('clearBtn').style.display = 'inline-flex';

    renderResults();
  }

  function setStatus(i, cls, text) {
    const el = document.getElementById(`status-${i}`);
    if (el) {
      el.className = `file-status status-${cls}`;
      el.textContent = text;
    }
  }

  async function analyzeDocument(base64Data, filename) {
    const systemPrompt = `You are an expert construction document analyst with deep knowledge of CSI MasterFormat divisions, construction specifications, submittals, shop drawings, RFIs, product data sheets, and construction contracts. 
    
    Analyze the provided PDF and return ONLY a valid JSON object (no markdown, no backticks, no extra text) with these fields:
    - title: string (descriptive document title)
    - docType: string (one of: "Specification Section", "Submittal", "Shop Drawing", "Product Data", "Material Sample", "Test Report", "RFI", "Change Order", "Contract", "Drawing", "Other")
    - csiDivision: string (CSI MasterFormat division number and name, e.g. "03 - Concrete" or "Unknown" if not applicable)
    - csiSection: string (specific section number if identifiable, e.g. "03 30 00" or "")
    - trade: string (trade or discipline, e.g. "Structural", "Mechanical", "Electrical", "Plumbing", "Architectural", "Civil", "Fire Protection", "Specialty")
    - priority: string (one of: "Critical", "High", "Medium", "Low" â€” based on safety/structural impact, schedule sensitivity, lead times)
    - summary: string (2-4 sentence summary of the document content and purpose)
    - keyItems: array of strings (4-8 specific important items, materials, specs, or requirements mentioned)
    - tags: array of strings (4-8 relevant tags for categorization, lowercase, e.g. "structural-steel", "fire-rating", "submittals-required")
    - notes: string (any flags, action items, or important notes the project team should know about, or empty string)
    
    Base priority on: Critical = life-safety or structural, High = schedule-critical or long lead, Medium = standard review, Low = informational.`;

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-allow-browser': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        system: systemPrompt,
        messages: [{
          role: 'user',
          content: [{
            type: 'document',
            source: { type: 'base64', media_type: 'application/pdf', data: base64Data }
          }, {
            type: 'text',
            text: `Analyze this construction document (filename: ${filename}) and return the JSON assessment.`
          }]
        }]
      })
    });

    const data = await response.json();
    const text = data.content.map(c => c.text || '').join('');
    const clean = text.replace(/```json|```/g, '').trim();
    return JSON.parse(clean);
  }

  // --- RENDER ---
  function renderResults() {
    document.getElementById('results').style.display = 'block';
    renderStats();
    renderGrid('gridView', analyzedDocs);
    renderGrouped('byTopicView', groupBy('csiDivision'));
    renderGrouped('byPriorityView', groupBy('priority'), ['Critical', 'High', 'Medium', 'Low']);
    renderGrouped('byTypeView', groupBy('docType'));
    switchTab('grid', document.querySelector('.tab'));
    document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  function renderStats() {
    const stats = document.getElementById('statsRow');
    const criticalCount = analyzedDocs.filter(d => d.priority === 'Critical').length;
    const types = [...new Set(analyzedDocs.map(d => d.docType))].length;
    const divisions = [...new Set(analyzedDocs.map(d => d.csiDivision))].length;

    stats.innerHTML = `
      <div class="stat-card"><div class="stat-value">${analyzedDocs.length}</div><div class="stat-label">Documents</div></div>
      <div class="stat-card"><div class="stat-value">${criticalCount}</div><div class="stat-label">Critical Priority</div></div>
      <div class="stat-card"><div class="stat-value">${types}</div><div class="stat-label">Document Types</div></div>
      <div class="stat-card"><div class="stat-value">${divisions}</div><div class="stat-label">CSI Divisions</div></div>
    `;
  }

  function createCard(doc, delay = 0) {
    const div = document.createElement('div');
    div.className = 'doc-card';
    div.style.animationDelay = `${delay}ms`;
    div.style.setProperty('--priority-color', PRIORITY_COLORS[doc.priority] || '#2c302b');
    div.innerHTML = `
      <div class="doc-card-top">
        <span class="doc-type-badge">${doc.docType}</span>
        <span class="priority-badge priority-${(doc.priority||'').toLowerCase()}">${doc.priority}</span>
      </div>
      <div class="doc-title">${doc.title}</div>
      <div class="doc-section">${doc.csiDivision}${doc.csiSection ? ' Â· Â§' + doc.csiSection : ''}</div>
      <div class="doc-summary">${doc.summary}</div>
      <div class="doc-tags">
        ${(doc.tags || []).slice(0, 5).map(t => `<span class="tag">${t}</span>`).join('')}
      </div>
      <div class="doc-footer">
        <span class="doc-filename">ðŸ“„ ${doc.filename}</span>
        <span class="doc-trade">${doc.trade}</span>
      </div>
    `;
    div.addEventListener('click', () => openModal(doc));
    return div;
  }

  function renderGrid(viewId, docs) {
    const view = document.getElementById(viewId);
    view.innerHTML = '';
    if (!docs.length) { view.innerHTML = '<div class="empty-state">No documents to display</div>'; return; }
    docs.forEach((doc, i) => view.appendChild(createCard(doc, i * 40)));
  }

  function groupBy(field, order) {
    const groups = {};
    analyzedDocs.forEach(doc => {
      const key = doc[field] || 'Unknown';
      if (!groups[key]) groups[key] = [];
      groups[key].push(doc);
    });
    if (order) {
      const ordered = {};
      order.forEach(k => { if (groups[k]) ordered[k] = groups[k]; });
      Object.keys(groups).forEach(k => { if (!ordered[k]) ordered[k] = groups[k]; });
      return ordered;
    }
    return groups;
  }

  function renderGrouped(viewId, groups, order) {
    const view = document.getElementById(viewId);
    view.innerHTML = '';
    view.className = 'group-view';
    const keys = order || Object.keys(groups).sort();
    keys.forEach(key => {
      if (!groups[key]) return;
      const block = document.createElement('div');
      block.className = 'group-block';
      block.innerHTML = `
        <div class="group-header">
          <div class="group-name">${key}</div>
          <div class="group-count">${groups[key].length} document${groups[key].length !== 1 ? 's' : ''}</div>
        </div>
        <div class="group-body" id="group-${key.replace(/\s+/g,'-')}"></div>
      `;
      view.appendChild(block);
      const body = block.querySelector('.group-body');
      groups[key].forEach((doc, i) => body.appendChild(createCard(doc, i * 30)));
    });
  }

  function switchTab(tabName, el) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    if (el) el.classList.add('active');

    document.getElementById('gridView').style.display = 'none';
    ['byTopicView', 'byPriorityView', 'byTypeView'].forEach(id => {
      document.getElementById(id).style.display = 'none';
    });

    if (tabName === 'grid') {
      document.getElementById('gridView').style.display = 'grid';
    } else if (tabName === 'byTopic') {
      document.getElementById('byTopicView').style.display = 'block';
    } else if (tabName === 'byPriority') {
      document.getElementById('byPriorityView').style.display = 'block';
    } else if (tabName === 'byType') {
      document.getElementById('byTypeView').style.display = 'block';
    }
  }

  // --- MODAL ---
  function openModal(doc) {
    document.getElementById('modalTitle').textContent = doc.title;
    document.getElementById('modalBody').innerHTML = `
      <div class="modal-grid">
        <div class="modal-field">
          <div class="modal-field-label">Document Type</div>
          <div class="modal-field-value">${doc.docType}</div>
        </div>
        <div class="modal-field">
          <div class="modal-field-label">Priority</div>
          <div class="modal-field-value"><span class="priority-badge priority-${(doc.priority||'').toLowerCase()}">${doc.priority}</span></div>
        </div>
        <div class="modal-field">
          <div class="modal-field-label">CSI Division</div>
          <div class="modal-field-value" style="color:var(--blue)">${doc.csiDivision}</div>
        </div>
        <div class="modal-field">
          <div class="modal-field-label">CSI Section</div>
          <div class="modal-field-value" style="color:var(--blue)">${doc.csiSection || 'â€”'}</div>
        </div>
        <div class="modal-field">
          <div class="modal-field-label">Trade / Discipline</div>
          <div class="modal-field-value">${doc.trade}</div>
        </div>
        <div class="modal-field">
          <div class="modal-field-label">Source File</div>
          <div class="modal-field-value" style="font-family:'IBM Plex Mono',monospace;font-size:0.78rem;">${doc.filename}</div>
        </div>
      </div>
      <div class="modal-field">
        <div class="modal-field-label">Summary</div>
        <div class="modal-field-value">${doc.summary}</div>
      </div>
      ${doc.keyItems && doc.keyItems.length ? `
      <div class="modal-field">
        <div class="modal-field-label">Key Items & Requirements</div>
        <div class="modal-field-value">
          ${doc.keyItems.map(item => `<div style="padding:0.3rem 0;border-bottom:1px solid var(--border);font-size:0.85rem;">â–¸ ${item}</div>`).join('')}
        </div>
      </div>` : ''}
      ${doc.notes ? `
      <div class="modal-field">
        <div class="modal-field-label">âš  Action Items / Notes</div>
        <div class="modal-field-value" style="color:var(--warn);background:rgba(255,184,0,0.08);padding:0.75rem;border:1px solid rgba(255,184,0,0.2);">${doc.notes}</div>
      </div>` : ''}
      <div class="modal-field">
        <div class="modal-field-label">Tags</div>
        <div class="doc-tags">${(doc.tags||[]).map(t => `<span class="tag">${t}</span>`).join('')}</div>
      </div>
    `;
    document.getElementById('modalOverlay').classList.add('open');
  }

  function closeModal(e) {
    if (e.target === document.getElementById('modalOverlay')) closeModalBtn();
  }
  function closeModalBtn() {
    document.getElementById('modalOverlay').classList.remove('open');
  }
  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModalBtn(); });

  // --- EXPORTS ---
  function downloadJSON() {
    const blob = new Blob([JSON.stringify(analyzedDocs, null, 2)], { type: 'application/json' });
    triggerDownload(blob, 'specsort-analysis.json');
  }

  function downloadCSV() {
    const headers = ['Filename', 'Title', 'Document Type', 'Priority', 'CSI Division', 'CSI Section', 'Trade', 'Summary', 'Tags', 'Notes'];
    const rows = analyzedDocs.map(d => [
      d.filename, d.title, d.docType, d.priority, d.csiDivision, d.csiSection, d.trade, d.summary,
      (d.tags || []).join('; '), d.notes
    ].map(v => `"${(v || '').replace(/"/g, '""')}"`));
    const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    triggerDownload(blob, 'specsort-analysis.csv');
  }

  function downloadHTML() {
    const html = `<!DOCTYPE html>
<html><head><meta charset="UTF-8">
<title>SpecSort Report</title>
<style>
body{font-family:Arial,sans-serif;max-width:1100px;margin:0 auto;padding:2rem;background:#f5f5f5;color:#222;}
h1{color:#0e0e0e;border-bottom:3px solid #c8f000;padding-bottom:0.5rem;}
h2{color:#333;margin-top:2rem;font-size:1rem;text-transform:uppercase;letter-spacing:0.08em;}
.doc{background:#fff;border:1px solid #ddd;border-left:4px solid #ccc;padding:1rem;margin-bottom:1rem;}
.doc.priority-critical{border-left-color:#ff4444;}
.doc.priority-high{border-left-color:#ff6b2b;}
.doc.priority-medium{border-left-color:#ffb800;}
.doc.priority-low{border-left-color:#7cb800;}
.badge{display:inline-block;padding:2px 8px;font-size:0.75rem;font-weight:bold;margin-right:0.5rem;}
.csi{color:#0066cc;font-family:monospace;font-size:0.85rem;}
.tag{display:inline-block;background:#f0f0f0;padding:2px 8px;font-size:0.72rem;margin:2px;border:1px solid #ddd;}
.note{background:#fff8e1;border:1px solid #ffb800;padding:0.5rem;margin-top:0.5rem;font-size:0.85rem;}
.meta{display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.5rem;margin:0.5rem 0;font-size:0.85rem;}
.meta-item label{font-weight:bold;display:block;font-size:0.7rem;text-transform:uppercase;color:#666;}
ul{padding-left:1.2rem;margin:0.5rem 0;}
li{font-size:0.85rem;margin:2px 0;}
</style></head><body>
<h1>SpecSort â€” Construction Document Report</h1>
<p><strong>Generated:</strong> ${new Date().toLocaleString()} Â· <strong>Documents:</strong> ${analyzedDocs.length}</p>
${analyzedDocs.map(d => `
<div class="doc priority-${(d.priority||'').toLowerCase()}">
  <h2>${d.title}</h2>
  <div><span class="badge" style="background:#f0f0f0">${d.docType}</span><span class="badge" style="background:${PRIORITY_COLORS[d.priority]||'#ccc'};color:${d.priority==='Low'?'#333':'#fff'}">${d.priority} Priority</span></div>
  <div class="meta">
    <div class="meta-item"><label>CSI Division</label><span class="csi">${d.csiDivision}</span></div>
    <div class="meta-item"><label>Section</label><span class="csi">${d.csiSection || 'â€”'}</span></div>
    <div class="meta-item"><label>Trade</label>${d.trade}</div>
  </div>
  <p>${d.summary}</p>
  ${d.keyItems && d.keyItems.length ? `<ul>${d.keyItems.map(i => `<li>${i}</li>`).join('')}</ul>` : ''}
  ${d.notes ? `<div class="note">âš  ${d.notes}</div>` : ''}
  <div>${(d.tags||[]).map(t => `<span class="tag">${t}</span>`).join('')}</div>
  <p style="color:#999;font-size:0.75rem;margin-top:0.5rem;">Source: ${d.filename}</p>
</div>`).join('')}
</body></html>`;
    const blob = new Blob([html], { type: 'text/html' });
    triggerDownload(blob, 'specsort-report.html');
  }

  function triggerDownload(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }
</script>
</body>
</html>
